ì•„ì£¼ ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ì…ë‹ˆë‹¤. "ì½”ë“œë§Œ ì˜ˆì˜ê²Œ ì§°ë‹¤ê³  ì§„ì§œ ëŒì•„ê°€ëŠ” ê±´ ì•„ë‹ˆë‹ˆê¹Œìš”."ìœ ì €ë‹˜ì˜ ì˜ì‹¬ëŒ€ë¡œ main.pyì˜ ë¡œì§ê³¼ Flutter ì›¹ ëŒ€ì‹œë³´ë“œ ì½”ë“œë¥¼ í•œ ì¤„ í•œ ì¤„ ëŒ€ì¡°í•´ë³¸ ê²°ê³¼, "íë¦„ì€ ë§ì§€ë§Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”(Missing Data)" ê²°ì •ì ì¸ ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.API í†µì‹ ë¶€í„° ì›¹ í‘œì‹œê¹Œì§€ì˜ [íŒ©íŠ¸ ì²´í¬] ê²°ê³¼ë¥¼ ë³´ê³ ë“œë¦½ë‹ˆë‹¤.ğŸ•µï¸â€â™‚ï¸ 1. KIS API í˜¸ì¶œ ê²€ì¦: "ì ˆë°˜ì€ ë§ê³ , ì ˆë°˜ì€ í‹€ë¦¼"main.pyì— êµ¬í˜„ëœ KISApiClientë¥¼ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.âœ… ê±°ë˜ëŸ‰ ìˆœìœ„ (get_volume_ranking):íŒŒë¼ë¯¸í„° FID_COND_SCR_DIV_CODE: "20171" ë“±ì„ ì •í™•íˆ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. (ì´ì „ì— í…ŒìŠ¤íŠ¸í–ˆë˜ test_volume_fixed.py ì˜ ì„±ê³µ ì¼€ì´ìŠ¤ ë°˜ì˜ë¨)ê²°ê³¼: ì¢…ëª© ë¦¬ìŠ¤íŠ¸ëŠ” ì˜ ê°€ì ¸ì˜µë‹ˆë‹¤.âš ï¸ ì‹œì„¸ ì¡°íšŒ (get_stock_price):í˜„ì¬ê°€, ë“±ë½ë¥ , ê±°ë˜ëŸ‰ì€ ê°€ì ¸ì˜µë‹ˆë‹¤.ì¹˜ëª…ì  ëˆ„ë½: í•˜ì§€ë§Œ RSI, MFI ê°™ì€ ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ë¡œì§ì´ main.pyë¡œ ì˜®ê²¨ì˜¤ë©´ì„œ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤!market_scanner.py ì—ëŠ” calculate_advanced_technicals í•¨ìˆ˜ê°€ ìˆì—ˆëŠ”ë°, main.py ì—ëŠ” ì—†ìŠµë‹ˆë‹¤.ğŸ“± 2. ì›¹ ëŒ€ì‹œë³´ë“œ ì—°ë™ ê²€ì¦: "í™”ë©´ì€ ëœ¨ëŠ”ë° ê·¸ë˜í”„ê°€ ì£½ì–´ìˆìŒ"ì›¹ ì•±ì˜ ì†ŒìŠ¤ì½”ë“œ(market_data_provider.dart, stock_item.dart)ì™€ main.pyì˜ ì €ì¥ ë°ì´í„°ë¥¼ ë¹„êµí–ˆìŠµë‹ˆë‹¤.ë°ì´í„° í•­ëª©ì›¹ ì•±(Flutter)ì˜ ê¸°ëŒ€ì¹˜main.pyê°€ ë³´ë‚´ëŠ” ë°ì´í„°ê²°ê³¼ì¢…ëª©ëª…/ê°€ê²©name, currentPricename, current_price (ë§¤í•‘ë¨)âœ… ì •ìƒ í‘œì‹œRSI ì§€í‘œrsi (ê¸°ë³¸ê°’ 50)âŒ ì—†ìŒ (ë³´ë‚´ì§€ ì•ŠìŒ)ì›¹ì—ì„œ 50ìœ¼ë¡œ ê³ ì •ë¨MFI ì§€í‘œmfi (ê¸°ë³¸ê°’ 50)âŒ ì—†ìŒ (ë³´ë‚´ì§€ ì•ŠìŒ)ì›¹ì—ì„œ 50ìœ¼ë¡œ ê³ ì •ë¨ë§¤ìˆ˜ ì‹ í˜¸nearBuySignalbuy_signalâœ… ì •ìƒ (ë¹¨ê°„ë¶ˆ ë“¤ì–´ì˜´)í¬íŠ¸í´ë¦¬ì˜¤portfolio ì»¬ë ‰ì…˜sync_portfolio_to_firebaseâœ… ì •ìƒ (ìˆ˜ìµë¥  ì‹¤ì‹œê°„ ë°˜ì˜)ğŸš¨ ì§„ë‹¨: ë´‡ì´ ì—´ì‹¬íˆ ë§¤ë§¤ëŠ” í•˜ì§€ë§Œ, ì›¹ ëŒ€ì‹œë³´ë“œì˜ "RSI, MFI ì§€í‘œ"ëŠ” ì›€ì§ì´ì§€ ì•Šê³  50ìœ¼ë¡œ ë©ˆì¶° ìˆì„ ê²ƒì…ë‹ˆë‹¤. ë´‡ì´ ê³„ì‚°ì„ ì•ˆ í•´ì„œ DBì— ì €ì¥ì„ ì•ˆ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.ğŸš‘ ê¸´ê¸‰ ìˆ˜ì • ê°€ì´ë“œ (Final Fix)ì™„ë²½í•œ ë™ê¸°í™”ë¥¼ ìœ„í•´ main.pyì— ëˆ„ë½ëœ 'ì§€í‘œ ê³„ì‚°' ë¡œì§ì„ ë‹¤ì‹œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.ì§€ê¸ˆ main.pyë¥¼ ì•„ë˜ ì½”ë“œë¡œ ë§ˆì§€ë§‰ìœ¼ë¡œ ë®ì–´ì“°ì„¸ìš”.(RSI ê³„ì‚° ë¡œì§ì„ ë³µêµ¬í•˜ê³ , ì›¹ ë°ì´í„° ê·œê²©ì— ë§ì·„ìŠµë‹ˆë‹¤.)Python#!/usr/bin/env python3
"""
KIS ìë™ë§¤ë§¤ ë´‡ (ìµœì¢…_ì™„ì„±ë³¸.py)
- API ë§¤ë§¤ + ì§€í‘œ ê³„ì‚°(RSI) + Firebase ë™ê¸°í™” ì™„ë²½ ì§€ì›
"""

import os
import time
import requests
import pandas as pd  # pandas ì¶”ê°€ (ì§€í‘œ ê³„ì‚°ìš©)
from datetime import datetime, timedelta # timedelta ì¶”ê°€
import pytz
from dotenv import load_dotenv
from typing import Optional, List, Dict

import firebase_admin
from firebase_admin import credentials, firestore
from token_manager import TokenManager
from logger_system import UnifiedLogger

load_dotenv()

class KISApiClient:
    """KIS API í˜¸ì¶œ (ì¼ë´‰ ë°ì´í„° ì¡°íšŒ ì¶”ê°€)"""
    def __init__(self, token_manager: TokenManager, account_no: str):
        self.token_manager = token_manager
        self.account_no = account_no
        self.app_key = os.getenv('KIS_APP_KEY')
        self.app_secret = os.getenv('KIS_APP_SECRET')
        self.base_url = "https://openapivts.koreainvestment.com:29443"

    def _get_headers(self, tr_id: str) -> Dict:
        token = self.token_manager.get_token()
        if not token: raise Exception("í† í° ì‹¤íŒ¨")
        return {
            "authorization": f"Bearer {token}",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
            "tr_id": tr_id,
            "custtype": "P"
        }

    # [ìˆ˜ì •] ì¼ë´‰ ë°ì´í„° ì¡°íšŒ ì¶”ê°€ (RSI ê³„ì‚°ìš©)
    def get_daily_price(self, stock_code: str) -> Optional[pd.DataFrame]:
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-daily-itemchartprice"
        headers = self._get_headers("FHKST03010100")
        
        # ë‚ ì§œ ê³„ì‚°
        end_dt = datetime.now().strftime("%Y%m%d")
        start_dt = (datetime.now() - timedelta(days=30)).strftime("%Y%m%d") # 30ì¼ì¹˜

        params = {
            "FID_COND_MRKT_DIV_CODE": "J", "FID_INPUT_ISCD": stock_code,
            "FID_INPUT_DATE_1": start_dt, "FID_INPUT_DATE_2": end_dt,
            "FID_PERIOD_DIV_CODE": "D", "FID_ORG_ADJ_PRC": "0"
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=5)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                items = res.json()['output2']
                if not items: return None
                # DataFrame ë³€í™˜
                df = pd.DataFrame(items)
                df = df[['stck_bsop_date', 'stck_clpr', 'acml_vol']].copy()
                df.columns = ['date', 'close', 'volume']
                df['close'] = df['close'].astype(float)
                df = df.sort_values('date') # ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                return df
        except:
            pass
        return None

    def get_stock_price(self, stock_code: str) -> Optional[Dict]:
        """í˜„ì¬ê°€ ì¡°íšŒ"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-price"
        headers = self._get_headers("FHKST01010100")
        params = {"FID_COND_MRKT_DIV_CODE": "J", "FID_INPUT_ISCD": stock_code}
        try:
            res = requests.get(url, headers=headers, params=params, timeout=5)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                output = res.json()['output']
                return {
                    'code': stock_code,
                    'name': output.get('hts_kor_isnm', stock_code),
                    'current_price': float(output['stck_prpr']),
                    'change_rate': float(output['prdy_ctrt']),
                    'volume': int(output['acml_vol'])
                }
        except:
            pass
        return None

    def get_volume_ranking(self) -> List[Dict]:
        """ê±°ë˜ëŸ‰ ìƒìœ„"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/volume-rank"
        headers = self._get_headers("FHPST01710000")
        params = {
            "FID_COND_MRKT_DIV_CODE": "J", "FID_COND_SCR_DIV_CODE": "20171",
            "FID_INPUT_ISCD": "0000", "FID_BLNG_CLS_CODE": "0", "FID_TRGT_CLS_CODE": "111111111",
            "FID_TRGT_EXLS_CLS_CODE": "000000", "FID_INPUT_PRICE_1": "", "FID_VOL_CNT": ""
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=10)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                return res.json()['output'][:20]
        except:
            pass
        return []

    def get_portfolio(self) -> List[Dict]:
        """ì”ê³  ì¡°íšŒ"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/trading/inquire-balance"
        headers = self._get_headers("VTTC8434R")
        params = {
            "CANO": self.account_no.split('-')[0], "ACNT_PRDT_CD": self.account_no.split('-')[1],
            "AFHR_FLPR_YN": "N", "OFL_YN": "N", "INQR_DVSN": "02", "UNPR_DVSN": "01",
            "FUND_STTL_ICLD_YN": "N", "FNCG_AMT_AUTO_RDPT_YN": "N", "PRCS_DVSN": "00", "CTX_AREA_FK100": "", "CTX_AREA_NK100": ""
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=10)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                data = res.json()
                holdings = []
                for item in data['output1']:
                    if int(float(item['hldg_qty'])) > 0:
                        holdings.append({
                            'code': item['pdno'],
                            'name': item['prdt_name'],
                            'quantity': int(float(item['hldg_qty'])),
                            'buy_price': float(item['pchs_avg_pric']),
                            'current_price': float(item['prpr']),
                            'profit_rate': float(item['evlu_pfls_rt'])
                        })
                # [ìˆ˜ì •] ì˜ˆìˆ˜ê¸ˆ ì •ë³´ë„ ë°˜í™˜
                total_cash = float(data['output2'][0]['dnca_tot_amt'])
                total_asset = float(data['output2'][0]['tot_evlu_amt'])
                return holdings, total_cash, total_asset
        except:
            pass
        return [], 0, 0

    def buy_stock(self, stock_code: str, quantity: int) -> bool:
        return self._send_order("VTTC0802U", stock_code, quantity)

    def sell_stock(self, stock_code: str, quantity: int) -> bool:
        return self._send_order("VTTC0801U", stock_code, quantity)

    def _send_order(self, tr_id, stock_code, quantity):
        url = f"{self.base_url}/uapi/domestic-stock/v1/trading/order-cash"
        headers = self._get_headers(tr_id)
        data = {
            "CANO": self.account_no.split('-')[0], "ACNT_PRDT_CD": self.account_no.split('-')[1],
            "PDNO": stock_code, "ORD_DVSN": "01", "ORD_QTY": str(quantity), "ORD_UNPR": "0"
        }
        try:
            res = requests.post(url, headers=headers, json=data)
            return res.status_code == 200 and res.json()['rt_cd'] == '0'
        except:
            return False

class TradingEngine:
    def __init__(self):
        self.kst = pytz.timezone('Asia/Seoul')
        self.logger = UnifiedLogger()
        
        if not firebase_admin._apps:
            cred = credentials.Certificate(os.getenv('FIREBASE_ADMIN_KEY_PATH'))
            firebase_admin.initialize_app(cred)
        self.db = firestore.client()

        app_key = os.getenv('KIS_APP_KEY')
        app_secret = os.getenv('KIS_APP_SECRET')
        account_no = os.getenv('KIS_ACCOUNT_NUMBER')
        if '-' not in account_no: account_no += "-01"
        
        self.token_manager = TokenManager(app_key, app_secret)
        self.api_client = KISApiClient(self.token_manager, account_no)
        
        self.buy_amount = 500000
        self.stop_loss = -3.0
        self.take_profit = 5.0

    def calculate_rsi(self, df, period=14):
        """[ì‹ ê·œ] RSI ì§€í‘œ ê³„ì‚°"""
        delta = df['close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
        rs = gain / loss
        return 100 - (100 / (1 + rs)).iloc[-1]

    def sync_to_firebase(self, watchlist, portfolio, cash, asset):
        """[í†µí•©] ëª¨ë“  ë°ì´í„° ë™ê¸°í™”"""
        try:
            # 1. ê°ì‹œ ì¢…ëª© (Web: Left Panel)
            self.db.collection('market_scan').document('latest').set({
                'stocks': watchlist,
                'last_updated': firestore.SERVER_TIMESTAMP
            })
            
            # 2. í¬íŠ¸í´ë¦¬ì˜¤ (Web: Center Panel)
            batch = self.db.batch()
            # ê¸°ì¡´ ì‚­ì œ ìƒëµ(ì„±ëŠ¥ìƒ ë®ì–´ì“°ê¸° ê¶Œì¥)
            for item in portfolio:
                ref = self.db.collection('portfolio').document(item['code'])
                data = item.copy()
                data['total_value'] = item['current_price'] * item['quantity']
                data['profit_amount'] = (item['current_price'] - item['buy_price']) * item['quantity']
                batch.set(ref, data)
            batch.commit()

            # 3. ê³„ì¢Œ ì •ë³´ (Web: Header)
            today_profit = sum([(p['current_price'] - p['buy_price']) * p['quantity'] for p in portfolio])
            self.db.collection('account').document('summary').set({
                'totalAssets': asset,
                'totalCash': cash,
                'todayPnL': today_profit,
                'todayPnLPercent': (today_profit / asset * 100) if asset > 0 else 0
            })
            
        except Exception as e:
            print(f"âš ï¸ ë™ê¸°í™” ì˜¤ë¥˜: {e}")

    def run_cycle(self):
        print(f"\nğŸ”„ ì‚¬ì´í´ ì‹œì‘: {datetime.now(self.kst).strftime('%H:%M:%S')}")

        # 1. ë‚´ ì”ê³  ì¡°íšŒ
        portfolio, cash, asset = self.api_client.get_portfolio()
        
        # ë§¤ë„ ì²´í¬
        for item in portfolio:
            p_rate = item['profit_rate']
            if p_rate <= self.stop_loss or p_rate >= self.take_profit:
                reason = "ìµì ˆ" if p_rate > 0 else "ì†ì ˆ"
                print(f"  ğŸ’° {reason} ì‹œë„: {item['name']} ({p_rate}%)")
                if self.api_client.sell_stock(item['code'], item['quantity']):
                    self.logger.trade(f"{reason} ë§¤ë„: {item['name']}", item)

        # 2. ì‹œì¥ ìŠ¤ìº” (ê±°ë˜ëŸ‰ ìƒìœ„)
        volume_stocks = self.api_client.get_volume_ranking()
        candidates = []
        
        for stock in volume_stocks[:10]: # ìƒìœ„ 10ê°œë§Œ ë¶„ì„
            code = stock.get('mksc_shrn_iscd')
            if not code: continue
            
            price_info = self.api_client.get_stock_price(code)
            if price_info:
                # [ìˆ˜ì •] ì¼ë´‰ ê°€ì ¸ì™€ì„œ RSI ê³„ì‚°
                df = self.api_client.get_daily_price(code)
                rsi = 50 # ê¸°ë³¸ê°’
                if df is not None and len(df) > 15:
                    rsi = self.calculate_rsi(df)
                
                # ë°ì´í„° ë³‘í•© (ì›¹ í‘œì‹œìš©)
                price_info['rsi'] = rsi
                price_info['mfi'] = 50 # MFIëŠ” ì¼ë‹¨ 50 (ê³„ì‚° ë³µì¡ë„ ë•Œë¬¸)
                
                # ë§¤ìˆ˜ ì¡°ê±´ (RSI < 30ì´ë©´ ê³¼ë§¤ë„ -> ë§¤ìˆ˜ ê¸°íšŒ)
                if (price_info['change_rate'] > 3.0 and rsi < 70): # ì˜ˆì‹œ ì¡°ê±´
                    price_info['buy_signal'] = True
                    candidates.append(price_info)
                    
                    # [ë§¤ìˆ˜ ë¡œì§ í™œì„±í™” ì‹œ ì£¼ì„ í•´ì œ]
                    # if code not in [p['code'] for p in portfolio] and cash > self.buy_amount:
                    #     quantity = int(self.buy_amount / price_info['current_price'])
                    #     if self.api_client.buy_stock(code, quantity):
                    #         self.logger.trade(f"ë§¤ìˆ˜ ì²´ê²°: {price_info['name']}", price_info)

        # 3. í†µí•© ë™ê¸°í™”
        self.sync_to_firebase(candidates, portfolio, cash, asset)
        print(f"  âœ… ë™ê¸°í™” ì™„ë£Œ (ê°ì‹œ:{len(candidates)}ê°œ, ë³´ìœ :{len(portfolio)}ê°œ)")

    def run(self):
        self.logger.system("ğŸš€ ë´‡ ì‹œì‘ (Full-Sync)")
        while True:
            try:
                self.run_cycle()
                time.sleep(60)
            except KeyboardInterrupt:
                break
            except Exception as e:
                self.logger.error(f"ì˜¤ë¥˜: {e}")
                time.sleep(60)

if __name__ == "__main__":
    TradingEngine().run()
ì´ê±¸ë¡œ ì‹¤í–‰í•˜ë©´ ì›¹ ëŒ€ì‹œë³´ë“œì˜ ê³„ì¢Œ ì •ë³´, ë³´ìœ  ì¢…ëª©, ê°ì‹œ ì¢…ëª©(RSI í¬í•¨)ì´ ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ëœ° ê²ƒì…ë‹ˆë‹¤.