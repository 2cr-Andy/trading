ëƒ‰ì •í•˜ê²Œ í‰ê°€í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. **"ì ˆë°˜ì˜ ì„±ê³µ"**ì…ë‹ˆë‹¤.

ì´ì „ë³´ë‹¤ëŠ” íŒŒì¼ì´ ì •ë¦¬ëœ ëŠë‚Œì´ ë“¤ì§€ë§Œ, ê°€ì¥ ì¹˜ëª…ì ì¸ ë¬¸ì œì¸ 'ë¡œì§ ì¤‘ë³µ'ê³¼ 'ë”°ë¡œ ë…¸ëŠ” ë¶€í’ˆë“¤' ë¬¸ì œëŠ” ì—¬ì „íˆ í•´ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

ìœ ì €ë‹˜ê»˜ì„œ **"ìˆ˜ì •í–ˆë‹¤"**ê³  í•˜ì…¨ì§€ë§Œ, ì‹¤ì œë¡œëŠ” "ê¸°ì¡´ ì½”ë“œë¥¼ ì´ë¦„ë§Œ ë°”ê¿”ì„œ main.pyì— ë¶™ì—¬ë„£ê¸°" í•˜ì‹  ê²ƒì— ê°€ê¹ìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ ë˜ë©´ TokenManagerë¥¼ ì•„ë¬´ë¦¬ ì˜ ë§Œë“¤ì–´ë„ main.pyê°€ ì“°ì§€ë¥¼ ì•Šìœ¼ë‹ˆ ë¬´ìš©ì§€ë¬¼ì…ë‹ˆë‹¤.

ğŸ” íŒ©íŠ¸ ì²´í¬: "ê¹”ë”í•˜ì§€ ì•Šì€" 3ê°€ì§€ ì¦ê±°
1. TokenManagerë¥¼ ë§Œë“¤ì–´ë†“ê³  ì™œ ì•ˆ ì“°ì‹œë‚˜ìš”? (ê°€ì¥ ì‹¬ê°)
ìƒí™©: token_manager.pyë¼ëŠ” í›Œë¥­í•œ í† í° ê´€ë¦¬ìë¥¼ ë§Œë“œì…¨ìŠµë‹ˆë‹¤.

ë¬¸ì œ: ì •ì‘ ë©”ì¸ ë´‡ì¸ main.pyì˜ SimpleAutoTrader í´ë˜ìŠ¤ëŠ” ì´ê±¸ importí•´ì„œ ì“°ì§€ ì•Šê³ , ìê¸° í˜¼ì kis_token.json íŒŒì¼ì„ ì§ì ‘ ì—´ì–´ì„œ ì½ê³  ìˆìŠµë‹ˆë‹¤. (ë¼ì¸ 18-24)

ìœ„í—˜: ë§Œì•½ market_scanner.pyë‚˜ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ í† í°ì„ ê°±ì‹ í•˜ëŠ” ìˆœê°„ì— main.pyê°€ íŒŒì¼ì„ ì½ìœ¼ë©´, **íŒŒì¼ ê¹¨ì§(JSON Decode Error)**ì´ë‚˜ êµ¬ë²„ì „ í† í° ì‚¬ìš©ìœ¼ë¡œ ë´‡ì´ ë©ˆì¶¥ë‹ˆë‹¤. "ê¸ˆê³ (Manager)"ë¥¼ ìƒ€ëŠ”ë° ëˆì„ "ì±…ìƒ ìœ„(íŒŒì¼ ì§ì ‘ ì½ê¸°)"ì— ë‘ëŠ” ê²©ì…ë‹ˆë‹¤.

2. ìŒë‘¥ì´ ë¡œì§ (Code Duplication)
ìƒí™©: main.pyì—ë„ get_stock_priceê°€ ìˆê³ , market_scanner.pyë‚˜ realtime_market_update.pyì—ë„ ë˜‘ê°™ì€ API í˜¸ì¶œ í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.

ë¬¸ì œ: KIS API ì£¼ì†Œê°€ ë°”ë€Œê±°ë‚˜ íŒŒë¼ë¯¸í„°ë¥¼ ìˆ˜ì •í•´ì•¼ í•  ë•Œ, ëª¨ë“  íŒŒì¼ì„ ë‹¤ ì—´ì–´ì„œ ê³ ì³ì•¼ í•©ë‹ˆë‹¤. í•˜ë‚˜ë¼ë„ ë¹¼ë¨¹ìœ¼ë©´ ë²„ê·¸ê°€ í„°ì§‘ë‹ˆë‹¤. ì´ê²ƒì´ "ìœ ì§€ë³´ìˆ˜ ì§€ì˜¥"ì˜ ì‹œì‘ì…ë‹ˆë‹¤.

3. MVVM íŒ¨í„´ ë¯¸ì ìš©
ìƒí™©: main.py í•˜ë‚˜ì— **API í†µì‹ (Model) + ë§¤ë§¤ íŒë‹¨(ViewModel) + ì‹¤í–‰(View/Controller)**ì´ ë‹¤ ì„ì—¬ ìˆìŠµë‹ˆë‹¤.

í‰ê°€: ì´ê±´ MVVMì´ ì•„ë‹ˆë¼ God Object (ëª¨ë“  ê±¸ ë‹¤ í•˜ëŠ” ì „ì§€ì „ëŠ¥í•œ ê°ì²´) íŒ¨í„´ì…ë‹ˆë‹¤. ì½”ë“œê°€ ê¸¸ì–´ì§ˆìˆ˜ë¡ ê°ë‹¹ì´ ì•ˆ ë©ë‹ˆë‹¤.

ğŸ”§ 3ë‹¨ê³„ ê¸´ê¸‰ ìˆ˜ì • ì²˜ë°© (ê¹”ë”í•˜ê²Œ ë§Œë“œëŠ” ë²•)
ì§€ê¸ˆ main.pyë¥¼ **"ì§„ì§œ MVVM êµ¬ì¡°"**ë¡œ ë°”ê¾¸ëŠ” ì½”ë“œë¥¼ ì§œë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì´ëŒ€ë¡œ ë³µì‚¬í•´ì„œ main.pyë¥¼ ë®ì–´ì“°ì„¸ìš”.

í•µì‹¬ ë³€ê²½ì :

TokenManagerë¥¼ ê°€ì ¸ì™€ì„œ ì”ë‹ˆë‹¤. (íŒŒì¼ ì§ì ‘ ì ‘ê·¼ ê¸ˆì§€)

MarketScannerë¥¼ ê°€ì ¸ì™€ì„œ ì”ë‹ˆë‹¤. (API ë¡œì§ ì¤‘ë³µ ì œê±°)

SimpleAutoTraderëŠ” ì˜¤ì§ **"ë§¤ë§¤ íŒë‹¨"**ë§Œ í•©ë‹ˆë‹¤.

âœ… ìˆ˜ì •ëœ main.py (MVVM ì ìš© ë²„ì „)
Python

#!/usr/bin/env python3
"""
[Main] ìë™ë§¤ë§¤ ë´‡ ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸
MVVM íŒ¨í„´ ì ìš©: 
- Model: TokenManager, MarketScanner (ë°ì´í„° ë° API)
- ViewModel: TradingEngine (ë§¤ë§¤ ë¡œì§ íŒë‹¨)
"""

import time
import logging
from datetime import datetime
import pytz
from dotenv import load_dotenv

# ë§Œë“  ëª¨ë“ˆë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì¬ì‚¬ìš©!)
from token_manager import TokenManager
from market_scanner import MarketScanner
from logger_system import UnifiedLogger

load_dotenv()

class TradingEngine:  # ViewModel ì—­í• 
    def __init__(self):
        # 1. ë¡œê±° ë° ì„¤ì • ì´ˆê¸°í™”
        self.logger = UnifiedLogger()
        self.kst = pytz.timezone('Asia/Seoul')
        
        # 2. í•µì‹¬ ë¶€í’ˆ ì¡°ë¦½ (Dependency Injection)
        app_key = os.getenv('KIS_APP_KEY')
        app_secret = os.getenv('KIS_APP_SECRET')
        self.account_no = os.getenv('KIS_ACCOUNT_NUMBER')
        
        # [ì¤‘ìš”] TokenManager í•˜ë‚˜ë¥¼ ê³µìœ í•´ì„œ ì”ë‹ˆë‹¤!
        self.token_manager = TokenManager(app_key, app_secret)
        
        # [ì¤‘ìš”] MarketScannerì—ê²Œ í† í° ë§¤ë‹ˆì €ë¥¼ ë„˜ê²¨ì¤ë‹ˆë‹¤. (í† í° ê´€ë¦¬ ì¼ì›í™”)
        self.scanner = MarketScanner(app_key, app_secret, token_provider=self.token_manager.get_token)

    def run_cycle(self):
        """í•œ ë²ˆì˜ ë§¤ë§¤ ì‚¬ì´í´ ì‹¤í–‰"""
        self.logger.info("ğŸ”„ ë§¤ë§¤ ì‚¬ì´í´ ì‹œì‘")
        
        # 1. ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ (Modelì—ê²Œ ìœ„ì„)
        # ì§ì ‘ APIë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  scannerë¥¼ ì‹œí‚µë‹ˆë‹¤.
        candidates = self.scanner.scan_market() # ìƒìœ„ 10ê°œ ì¶”ì¶œ
        
        if not candidates:
            self.logger.warning("ì¡°ê±´ ë§Œì¡± ì¢…ëª© ì—†ìŒ")
            return

        # 2. ë§¤ë§¤ ë¡œì§ íŒë‹¨ (ViewModelì˜ ì—­í• )
        for stock in candidates:
            self.process_stock(stock)

    def process_stock(self, stock):
        """ê°œë³„ ì¢…ëª© ë§¤ë§¤ íŒë‹¨ ë¡œì§"""
        # ì—¬ê¸°ì„œ 'ì‚´ê¹Œ ë§ê¹Œ'ë§Œ ê³ ë¯¼í•˜ë©´ ë©ë‹ˆë‹¤. API í˜¸ì¶œ ì½”ë“œëŠ” ì—¬ê¸° ìˆìœ¼ë©´ ì•ˆ ë¨.
        code = stock['code']
        price = stock.get('current_price', 0)
        
        # ì˜ˆì‹œ ë¡œì§
        if stock.get('buy_signal'):
            self.logger.trade(f"ë§¤ìˆ˜ ì‹œê·¸ë„ ê°ì§€: {code}", stock)
            # self.trader.buy(...) # ë§¤ìˆ˜ ì‹¤í–‰ ë¡œì§ ì—°ê²°

    def start(self):
        """ë´‡ ì‹¤í–‰"""
        self.logger.system("ğŸš€ ë´‡ ì‹œì‘ (MVVM êµ¬ì¡°)")
        while True:
            try:
                self.run_cycle()
                time.sleep(300) # 5ë¶„ ëŒ€ê¸°
            except KeyboardInterrupt:
                self.logger.system("ë´‡ ì¢…ë£Œ")
                break
            except Exception as e:
                self.logger.error(f"ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
                time.sleep(60)

if __name__ == "__main__":
    import os
    engine = TradingEngine()
    engine.start()
ğŸ‘¨â€ğŸ’» ìœ ì €ë‹˜ì´ í•´ì•¼ í•  ì¼
token_manager.py: ì§€ê¸ˆ ì½”ë“œ ì¢‹ìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”.

market_scanner.py: ì§€ê¸ˆ main.pyì— ìˆëŠ” get_volume_ranking, get_stock_price ê°™ì€ í•¨ìˆ˜ë“¤ì´ market_scanner.pyì—ë„ ì˜ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , main.pyì—ì„œëŠ” ê·¸ í•¨ìˆ˜ë“¤ì„ ì‹¹ ì§€ìš°ì„¸ìš”.

ìœ„ì˜ ì½”ë“œ ì ìš©: main.pyë¥¼ ìœ„ ì½”ë“œë¡œ êµì²´í•˜ë©´, í† í° ê´€ë¦¬ê°€ TokenManager í•œ ê³³ìœ¼ë¡œ í†µì¼ë˜ë©´ì„œ "í† í° ê¼¬ì„" ë¬¸ì œê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.

ì´ë ‡ê²Œ í•´ì•¼ **"ê¹”ë”í•˜ë‹¤"**ê³  ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œì§ì´ íŒŒí¸í™”ëœ ê±´ ë²„ê·¸ì˜ ì˜¨ìƒì…ë‹ˆë‹¤. í†µí•©í•˜ì„¸ìš”!