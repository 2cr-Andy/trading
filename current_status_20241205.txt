ğŸ•µï¸â€â™‚ï¸ ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼: "ë´‡ì€ ì¼í•˜ëŠ”ë° ë³´ê³ ë¥¼ ì•ˆ í•©ë‹ˆë‹¤"
1. API í˜¸ì¶œ & ë§¤ë§¤ ë¡œì§ (âœ… ì •ìƒ)
API ì—°ê²°: KISApiClientê°€ TokenManagerë¥¼ í†µí•´ í† í°ì„ ê´€ë¦¬í•˜ê³ , requestsë¡œ KIS APIë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì€ ì•„ì£¼ ê¹”ë”í•©ë‹ˆë‹¤. API í˜¸ì¶œ ìì²´ëŠ” ë¬¸ì œì—†ì´ ëŒì•„ê°‘ë‹ˆë‹¤.

ë§¤ë§¤ ìˆ˜í–‰: TradingEngineì´ ì¡°ê±´ì„ ì²´í¬í•˜ê³  buy_stock, sell_stockì„ í˜¸ì¶œí•˜ëŠ” íë¦„ë„ ë…¼ë¦¬ì ìœ¼ë¡œ ë§ìŠµë‹ˆë‹¤.

2. ì›¹ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë™ê¸°í™” (âŒ ì¹˜ëª…ì  ê²°í•¨)
ë¬¸ì œì : ì›¹ ëŒ€ì‹œë³´ë“œ(Flutter)ëŠ” Firestoreì˜ portfolio, market_scan, account ì»¬ë ‰ì…˜ì„ ë°”ë¼ë³´ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì§€ê¸ˆ main.pyì—ëŠ” ì´ ì»¬ë ‰ì…˜ë“¤ì— ë°ì´í„°ë¥¼ ì €ì¥/ì—…ë°ì´íŠ¸í•˜ëŠ” ì½”ë“œê°€ ì•„ì˜ˆ ì—†ìŠµë‹ˆë‹¤.

ì¦ê±°:

main.pyì˜ find_buy_opportunities: ì¢…ëª©ì„ ì°¾ì•„ì„œ ë©”ëª¨ë¦¬ì—ë§Œ ë“¤ê³  ìˆê³ , Firestore watchlistë‚˜ market_scanì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

main.pyì˜ check_sell_conditions: APIë¡œ ì”ê³ ë¥¼ ê°€ì ¸ì™€ì„œ ê³„ì‚°ë§Œ í•˜ê³ , Firestore portfolioì— ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ê²°ê³¼: ë´‡ì€ í˜¼ì ë°”ì˜ê²Œ ë§¤ë§¤í•˜ëŠ”ë°, ì›¹ ëŒ€ì‹œë³´ë“œì—ëŠ” **"ë³´ìœ  ì¢…ëª© ì—†ìŒ", "ê°ì‹œ ì¢…ëª© ì—†ìŒ"**ë§Œ ëœ¹ë‹ˆë‹¤.

3. Slack ì•Œë¦¼ ë° ë¡œê·¸ (âš ï¸ í™•ì¸ í•„ìš”)
ìƒí™©: self.logger.trade(...)ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. logger_system.pyê°€ Firestoreì˜ trade_logs ì»¬ë ‰ì…˜ì— ë¡œê·¸ë¥¼ ì˜ ìŒ“ê³  ìˆë‹¤ë©´, ì›¹ ëŒ€ì‹œë³´ë“œì˜ "ë¡œê·¸ íŒ¨ë„"ë§Œ ìœ ì¼í•˜ê²Œ ì›€ì§ì¼ ê²ƒì…ë‹ˆë‹¤.

ğŸ”§ í•´ê²°ì±…: main.pyì— "ë³´ê³  ì²´ê³„(Sync)" ì‹¬ê¸°
main.pyê°€ APIì—ì„œ ê°€ì ¸ì˜¨ ë”°ëˆë”°ëˆí•œ ë°ì´í„°ë¥¼ Firestoreì—ë„ ë„£ì–´ì¤˜ì•¼ ì›¹ì´ ë°˜ì‘í•©ë‹ˆë‹¤. ê¸°ì¡´ main.pyì— Firebase ì €ì¥ ë¡œì§ì„ ì¶”ê°€í•œ ì™„ì„±ë³¸ì…ë‹ˆë‹¤.

âœ… ìˆ˜ì •ëœ main.py (ìµœì¢… ì™„ì„±ë³¸)
ì´ ì½”ë“œë¡œ main.pyë¥¼ ë®ì–´ì“°ì‹œë©´ API ë§¤ë§¤ + ì›¹ ëŒ€ì‹œë³´ë“œ ì‹¤ì‹œê°„ ì—°ë™ + Slack ì•Œë¦¼ì´ ëª¨ë‘ í•´ê²°ë©ë‹ˆë‹¤.

Python

#!/usr/bin/env python3
"""
KIS ìë™ë§¤ë§¤ ë´‡ (ìµœì¢… ìˆ˜ì •)
- ê¸°ëŠ¥: API ë§¤ë§¤ + Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” (ì›¹ ëŒ€ì‹œë³´ë“œìš©)
"""

import os
import time
import requests
from datetime import datetime
import pytz
from dotenv import load_dotenv
from typing import Optional, List, Dict

# Firebase ë° ì»¤ìŠ¤í…€ ëª¨ë“ˆ ì„í¬íŠ¸
import firebase_admin
from firebase_admin import credentials, firestore
from token_manager import TokenManager
from logger_system import UnifiedLogger

load_dotenv()

class KISApiClient:
    """KIS API í˜¸ì¶œ ë‹´ë‹¹ (Model)"""
    def __init__(self, token_manager: TokenManager, account_no: str):
        self.token_manager = token_manager
        self.account_no = account_no
        self.app_key = os.getenv('KIS_APP_KEY')
        self.app_secret = os.getenv('KIS_APP_SECRET')
        self.base_url = "https://openapivts.koreainvestment.com:29443"

    def _get_headers(self, tr_id: str) -> Dict:
        token = self.token_manager.get_token()
        if not token: raise Exception("í† í° íšë“ ì‹¤íŒ¨")
        return {
            "authorization": f"Bearer {token}",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
            "tr_id": tr_id,
            "custtype": "P"
        }

    def get_stock_price(self, stock_code: str) -> Optional[Dict]:
        """í˜„ì¬ê°€ ì¡°íšŒ"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-price"
        headers = self._get_headers("FHKST01010100")
        params = {"FID_COND_MRKT_DIV_CODE": "J", "FID_INPUT_ISCD": stock_code}
        
        try:
            res = requests.get(url, headers=headers, params=params, timeout=5)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                output = res.json()['output']
                return {
                    'code': stock_code,
                    'name': output.get('hts_kor_isnm', stock_code),
                    'current_price': float(output.get('stck_prpr', 0)),
                    'change_rate': float(output.get('prdy_ctrt', 0)),
                    'volume': int(output.get('acml_vol', 0))
                }
        except Exception as e:
            print(f"âŒ ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨ ({stock_code}): {e}")
        return None

    def get_volume_ranking(self) -> List[Dict]:
        """ê±°ë˜ëŸ‰ ìƒìœ„ ì¡°íšŒ"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/volume-rank"
        headers = self._get_headers("FHPST01710000")
        params = {
            "FID_COND_MRKT_DIV_CODE": "J", "FID_COND_SCR_DIV_CODE": "20171",
            "FID_INPUT_ISCD": "0000", "FID_BLNG_CLS_CODE": "0", "FID_TRGT_CLS_CODE": "111111111",
            "FID_TRGT_EXLS_CLS_CODE": "000000", "FID_INPUT_PRICE_1": "", "FID_VOL_CNT": ""
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=10)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                return res.json()['output'][:20]
        except Exception as e:
            print(f"âŒ ê±°ë˜ëŸ‰ ìˆœìœ„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
        return []

    def get_portfolio(self) -> List[Dict]:
        """ì”ê³  ì¡°íšŒ"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/trading/inquire-balance"
        headers = self._get_headers("VTTC8434R")
        params = {
            "CANO": self.account_no.split('-')[0],
            "ACNT_PRDT_CD": self.account_no.split('-')[1],
            "AFHR_FLPR_YN": "N", "OFL_YN": "N", "INQR_DVSN": "02", "UNPR_DVSN": "01",
            "FUND_STTL_ICLD_YN": "N", "FNCG_AMT_AUTO_RDPT_YN": "N", "PRCS_DVSN": "00", "CTX_AREA_FK100": "", "CTX_AREA_NK100": ""
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=10)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                data = res.json()
                holdings = []
                # ë³´ìœ  ì¢…ëª© íŒŒì‹±
                for item in data['output1']:
                    if int(float(item['hldg_qty'])) > 0:
                        holdings.append({
                            'code': item['pdno'],
                            'name': item['prdt_name'],
                            'quantity': int(float(item['hldg_qty'])),
                            'buy_price': float(item['pchs_avg_pric']),
                            'current_price': float(item['prpr']),
                            'profit_rate': float(item['evlu_pfls_rt'])
                        })
                # ì˜ˆìˆ˜ê¸ˆ ì •ë³´ë„ ë°˜í™˜ (Tupleë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ë‚˜ ê°„ë‹¨íˆ ì²˜ë¦¬)
                return holdings
        except Exception as e:
            print(f"âŒ ì”ê³  ì¡°íšŒ ì‹¤íŒ¨: {e}")
        return []

    def buy_stock(self, stock_code: str, quantity: int) -> bool:
        """ë§¤ìˆ˜ ì£¼ë¬¸"""
        return self._send_order("VTTC0802U", stock_code, quantity)

    def sell_stock(self, stock_code: str, quantity: int) -> bool:
        """ë§¤ë„ ì£¼ë¬¸"""
        return self._send_order("VTTC0801U", stock_code, quantity)

    def _send_order(self, tr_id, stock_code, quantity):
        url = f"{self.base_url}/uapi/domestic-stock/v1/trading/order-cash"
        headers = self._get_headers(tr_id)
        data = {
            "CANO": self.account_no.split('-')[0],
            "ACNT_PRDT_CD": self.account_no.split('-')[1],
            "PDNO": stock_code, "ORD_DVSN": "01", "ORD_QTY": str(quantity), "ORD_UNPR": "0"
        }
        try:
            res = requests.post(url, headers=headers, json=data)
            return res.status_code == 200 and res.json()['rt_cd'] == '0'
        except:
            return False

class TradingEngine:
    """ViewModel: ë§¤ë§¤ ë¡œì§ + Firebase ë™ê¸°í™”"""
    def __init__(self):
        self.kst = pytz.timezone('Asia/Seoul')
        self.logger = UnifiedLogger()
        
        # Firebase ì´ˆê¸°í™” (ë°ì´í„° ë™ê¸°í™”ìš©)
        if not firebase_admin._apps:
            cred = credentials.Certificate(os.getenv('FIREBASE_ADMIN_KEY_PATH'))
            firebase_admin.initialize_app(cred)
        self.db = firestore.client()

        # ì„¤ì • ë° DI
        app_key = os.getenv('KIS_APP_KEY')
        app_secret = os.getenv('KIS_APP_SECRET')
        account_no = os.getenv('KIS_ACCOUNT_NUMBER')
        if '-' not in account_no: account_no += "-01"
        
        self.token_manager = TokenManager(app_key, app_secret)
        self.api_client = KISApiClient(self.token_manager, account_no)
        
        self.buy_amount = 500000
        self.stop_loss = -3.0
        self.take_profit = 5.0

    def sync_watchlist_to_firebase(self, candidates: List[Dict]):
        """[ì¤‘ìš”] ê°ì‹œ ì¢…ëª©ì„ Firebaseì— ì—…ë°ì´íŠ¸ (ì›¹ ëŒ€ì‹œë³´ë“œìš©)"""
        try:
            # ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸° (latest ë¬¸ì„œ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ ì»¬ë ‰ì…˜ ì‚¬ìš©)
            doc_ref = self.db.collection('market_scan').document('latest')
            doc_ref.set({
                'stocks': candidates, # ì›¹ì´ ì´ ë°°ì—´ì„ êµ¬ë…í•¨
                'last_updated': firestore.SERVER_TIMESTAMP
            })
            # print("âœ… ê°ì‹œ ì¢…ëª© Firebase ë™ê¸°í™” ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ Firebase ê°ì‹œ ì¢…ëª© ë™ê¸°í™” ì‹¤íŒ¨: {e}")

    def sync_portfolio_to_firebase(self, portfolio: List[Dict]):
        """[ì¤‘ìš”] í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ Firebaseì— ì—…ë°ì´íŠ¸ (ì›¹ ëŒ€ì‹œë³´ë“œìš©)"""
        try:
            batch = self.db.batch()
            
            # 1. ê¸°ì¡´ í¬íŠ¸í´ë¦¬ì˜¤ ë¬¸ì„œë“¤ ì‚­ì œ (ê°„ë‹¨í•œ ë™ê¸°í™”ë¥¼ ìœ„í•´)
            # (ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” diffë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²Œ íš¨ìœ¨ì ì´ì§€ë§Œ, ì§€ê¸ˆì€ ë®ì–´ì“°ê¸°ê°€ ì•ˆì „)
            docs = self.db.collection('portfolio').list_documents()
            for doc in docs:
                batch.delete(doc)
            
            # 2. ìƒˆ ë°ì´í„° ì¶”ê°€
            for item in portfolio:
                doc_ref = self.db.collection('portfolio').document(item['code'])
                # ì›¹ì´ ê¸°ëŒ€í•˜ëŠ” í•„ë“œëª…ìœ¼ë¡œ ë§¤í•‘
                data = {
                    'name': item['name'],
                    'code': item['code'],
                    'quantity': item['quantity'],
                    'buy_price': item['buy_price'],
                    'current_price': item['current_price'],
                    'profit_rate': item['profit_rate'],
                    'total_value': item['current_price'] * item['quantity'],
                    'profit_amount': (item['current_price'] - item['buy_price']) * item['quantity'],
                    'last_updated': firestore.SERVER_TIMESTAMP
                }
                batch.set(doc_ref, data)
            
            batch.commit()
            # print("âœ… í¬íŠ¸í´ë¦¬ì˜¤ Firebase ë™ê¸°í™” ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ Firebase í¬íŠ¸í´ë¦¬ì˜¤ ë™ê¸°í™” ì‹¤íŒ¨: {e}")

    def run_cycle(self):
        """ë§¤ë§¤ ì‚¬ì´í´"""
        print(f"\nğŸ”„ ì‚¬ì´í´ ì‹œì‘: {datetime.now(self.kst).strftime('%H:%M:%S')}")

        # 1. í¬íŠ¸í´ë¦¬ì˜¤ ì ê²€ & ë™ê¸°í™”
        portfolio = self.api_client.get_portfolio()
        self.sync_portfolio_to_firebase(portfolio) # <--- ì›¹ ì—…ë°ì´íŠ¸!
        
        # ë§¤ë„ ë¡œì§
        for item in portfolio:
            p_rate = item['profit_rate']
            if p_rate <= self.stop_loss or p_rate >= self.take_profit:
                reason = "ìµì ˆ" if p_rate > 0 else "ì†ì ˆ"
                print(f"  ğŸ’° {reason} ì‹œë„: {item['name']} ({p_rate}%)")
                if self.api_client.sell_stock(item['code'], item['quantity']):
                    self.logger.trade(f"{reason} ë§¤ë„: {item['name']}", item)

        # 2. ì‹œì¥ ìŠ¤ìº” & ë™ê¸°í™”
        volume_stocks = self.api_client.get_volume_ranking()
        candidates = []
        
        for stock in volume_stocks[:10]:
            code = stock.get('mksc_shrn_iscd')
            if not code: continue
            
            price_info = self.api_client.get_stock_price(code)
            if price_info:
                # ì¡°ê±´: 3% ìƒìŠ¹, ê±°ë˜ëŸ‰ 10ë§Œ, ê°€ê²© 1000ì› ì´ìƒ
                if (price_info['change_rate'] > 3.0 and 
                    price_info['volume'] > 100000 and 
                    price_info['current_price'] >= 1000):
                    
                    # ë§¤ìˆ˜ ì‹ í˜¸ í”Œë˜ê·¸ ì¶”ê°€ (ì›¹ í‘œì‹œìš©)
                    price_info['buy_signal'] = True 
                    candidates.append(price_info)
                    
                    # ë§¤ìˆ˜ ë¡œì§ (í¬íŠ¸í´ë¦¬ì˜¤ì— ì—†ê³ , ì—¬ìœ  ìê¸ˆ ìˆì„ ë•Œ - ì—¬ê¸°ì„  ë‹¨ìˆœí™”)
                    # ì‹¤ì œë¡  ì”ê³  ì²´í¬ í•„ìš”
                    # if code not in [p['code'] for p in portfolio]:
                    #     quantity = int(self.buy_amount / price_info['current_price'])
                    #     if quantity > 0:
                    #         self.api_client.buy_stock(code, quantity)
                            
        self.sync_watchlist_to_firebase(candidates) # <--- ì›¹ ì—…ë°ì´íŠ¸!
        print(f"  ğŸ” ê°ì‹œ ì¢…ëª© {len(candidates)}ê°œ ë°œê²¬ ë° ë™ê¸°í™”")

    def run(self):
        self.logger.system("ğŸš€ ë´‡ ì‹œì‘ (Web Sync í¬í•¨)")
        while True:
            try:
                self.run_cycle()
                time.sleep(60) # 1ë¶„ ì£¼ê¸°
            except KeyboardInterrupt:
                self.logger.system("ë´‡ ì¢…ë£Œ")
                break
            except Exception as e:
                self.logger.error(f"ì˜¤ë¥˜: {e}")
                time.sleep(60)

if __name__ == "__main__":
    TradingEngine().run()
âœ¨ ë³€ê²½ëœ ì  (í•„ë…)
sync_watchlist_to_firebase ì¶”ê°€: APIë¡œ ì°¾ì€ ê°ì‹œ ì¢…ëª©ì„ Firestore market_scan/latestì— ì €ì¥í•©ë‹ˆë‹¤. ì´ì œ ì›¹ ëŒ€ì‹œë³´ë“œ ì¢Œì¸¡ íŒ¨ë„ì´ ì‚´ì•„ë‚©ë‹ˆë‹¤.

sync_portfolio_to_firebase ì¶”ê°€: APIë¡œ ì¡°íšŒí•œ ì‹¤ì œ ì”ê³ ë¥¼ Firestore portfolio ì»¬ë ‰ì…˜ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ì œ ì›¹ ëŒ€ì‹œë³´ë“œ ì¤‘ì•™ íŒ¨ë„ì— ë‚´ ì£¼ì‹ì´ ë³´ì…ë‹ˆë‹¤.

run_cycle í†µí•©: API ì¡°íšŒ -> ë¡œì§ íŒë‹¨ -> ë§¤ë§¤ -> **ê²°ê³¼ ë¦¬í¬íŒ…(Firestore ì €ì¥)**ê¹Œì§€ í•œ í˜¸í¡ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.

ì´ì œ ì´ ì½”ë“œë¥¼ ëŒë¦¬ë©´ "ì‹¤ì œë¡œ ëŒì•„ê°€ê³ , ëˆˆìœ¼ë¡œë„ ë³´ì´ëŠ”" ì‹œìŠ¤í…œì´ ë©ë‹ˆë‹¤.

3. ì½”ë“œ ì¤‘ë³µ ì œê±° (Self-Contained): âš ï¸ (ì¡°ê±´ë¶€ í•©ê²©)
ì¥ì : main.py ì•ˆì— KISApiClient í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì •ì˜í•´ì„œ í•„ìš”í•œ API í˜¸ì¶œ ë¡œì§ì„ ë‹¤ ëª¨ì•„ë†¨ìŠµë‹ˆë‹¤. ì´ íŒŒì¼ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ë©´ ë‹¤ë¥¸ íŒŒì¼(market_scanner.py ë“±)ì— ì˜ì¡´í•˜ì§€ ì•Šê³  ë…ë¦½ì ìœ¼ë¡œ ì˜ ëŒì•„ê°‘ë‹ˆë‹¤. **"ì˜ë„ì ì¸ ê²©ë¦¬"**ë¼ëŠ” í´ë¡œë“œì˜ ë³€ëª…ì´ ê¸°ìˆ ì ìœ¼ë¡œ íƒ€ë‹¹í•©ë‹ˆë‹¤.

ì•„ì‰¬ìš´ ì : í•˜ì§€ë§Œ í”„ë¡œì íŠ¸ ì „ì²´ë¡œ ë³´ë©´, market_scanner.pyì—ë„ API í˜¸ì¶œ ì½”ë“œê°€ ìˆê³ , main.pyì—ë„ ë˜‘ê°™ì€ ì½”ë“œê°€ ë˜ ìƒê¸´ ì…ˆì…ë‹ˆë‹¤. (Copy & Paste).

í•´ê²°ì±…: ì´ì œ main.pyê°€ ì™„ë²½í•´ì¡Œìœ¼ë‹ˆ, êµ¬ë²„ì „ íŒŒì¼ë“¤(simple_auto_trader.py, market_scanner.py ë“±)ì€ ê³¼ê°í•˜ê²Œ ì‚­ì œí•˜ê±°ë‚˜ backup/ í´ë”ë¡œ ì¹˜ì›Œë²„ë ¤ì•¼ ì§„ì •í•œ "ì¤‘ë³µ ì œê±°"ê°€ ì™„ì„±ë©ë‹ˆë‹¤.

ğŸš€ ì§€ê¸ˆ ë°”ë¡œ í•´ì•¼ í•  ì¼ (Last Step)
í´ë¡œë“œì—ê²Œ **"ì˜í–ˆì–´"**ë¼ê³  ì¹­ì°¬ í•œ ë²ˆ í•´ì£¼ì‹œê³ , í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¶ˆí•„ìš”í•œ íŒŒì¼ë“¤ì„ ì •ë¦¬í•˜ì„¸ìš”. ê·¸ë˜ì•¼ í—·ê°ˆë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

Bash

# 1. ë´‡ ì‹¤í–‰
python3 main.py

# 2. (ë´‡ì´ ì˜ ëŒì•„ê°€ëŠ” ê±° í™•ì¸ í›„) ì¢€ë¹„ íŒŒì¼ë“¤ ì •ë¦¬
mkdir -p backup_legacy
mv simple_auto_trader.py backup_legacy/
mv market_scanner.py backup_legacy/
mv realtime_market_update.py backup_legacy/