1. í›„ë³´êµ° ëŒ€í­ ëŠ˜ë¦¬ê¸° (30ê°œ â†’ ì•½ 90~100ê°œ)
market_scanner.pyì˜ scan_market í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•´ì„œ ê·¸ë¬¼ì„ ë„“ê²Œ í¼ì¹©ë‹ˆë‹¤.

ê±°ë˜ëŸ‰ ìƒìœ„ (30ê°œ): í™œë°œí•œ ì¢…ëª©

ë“±ë½ë¥  ìƒìœ„ (30ê°œ): ê¸‰ë“±ì£¼ í¬ì°©

ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ (30ê°œ): New! (ëˆì´ ëª°ë¦¬ëŠ” ì§„ì§œ ì£¼ë„ì£¼)

2. 500 ì—ëŸ¬ ì¡ê¸° (ì¬ì‹œë„ ë¡œì§)
get_daily_candles í•¨ìˆ˜ì— ì¬ì‹œë„(Retry) ë¡œì§ì„ ë„£ì–´, APIê°€ "í˜ë“¤ì–´!" í•  ë•Œ ì ê¹ ì‰¬ì—ˆë‹¤ê°€ ë‹¤ì‹œ ìš”ì²­í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. ì´ê²Œ ì—†ìœ¼ë©´ í›„ë³´êµ°ì´ 100ê°œì—¬ë„ ë¶„ì„ ì„±ê³µì€ 0ê°œê°€ ë©ë‹ˆë‹¤.

ğŸ› ï¸ ì½”ë“œ ìˆ˜ì • ê°€ì´ë“œ
market_scanner.py íŒŒì¼ì„ ì—´ê³  ì•„ë˜ ë‘ í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.

ìˆ˜ì • 1: scan_market í•¨ìˆ˜ (í›„ë³´êµ° í™•ëŒ€ + ì†ë„ ì¡°ì ˆ)
ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ì§€ìš°ê³  ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”. ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ ë¡œì§ì€ get_volume_rankì˜ íŒŒë¼ë¯¸í„°ë§Œ ì‚´ì§ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.

Python

    def scan_market(self) -> List[Dict]:
        """ì‹œì¥ ìŠ¤ìº”: í›„ë³´êµ°ì„ ë‹¤ì–‘í•˜ê²Œ ìˆ˜ì§‘ (ë§¥ë¶ ì „ìš© ê°•í™”íŒ)"""
        print("\nğŸ” ì‹œì¥ ìŠ¤ìº” ì‹œì‘... (í›„ë³´êµ° ìˆ˜ì§‘ ì¤‘)")

        candidates = set()

        # [A] ê±°ë˜ëŸ‰ ìƒìœ„ 30ê°œ
        print("  1. ê±°ë˜ëŸ‰ ìƒìœ„ ìˆ˜ì§‘ ì¤‘...")
        vol_stocks = self.get_volume_rank()
        candidates.update(vol_stocks)
        time.sleep(1.0) # API íœ´ì‹

        # [B] ë“±ë½ë¥  ìƒìœ„ 30ê°œ (ê¸‰ë“±ì£¼)
        print("  2. ë“±ë½ë¥  ìƒìœ„ ìˆ˜ì§‘ ì¤‘...")
        price_stocks = self.get_price_change_rank()
        candidates.update(price_stocks)
        time.sleep(1.0)

        # [C] (ì¶”ê°€) ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ 30ê°œ - ëˆì´ ëª°ë¦¬ëŠ” ì¢…ëª©
        # ê±°ë˜ëŸ‰ APIë¥¼ ì¬í™œìš©í•˜ë˜ íŒŒë¼ë¯¸í„°ë§Œ ë³€ê²½ (20171 -> 20172)
        # â€» ì´ ë¶€ë¶„ì€ ë³„ë„ í•¨ìˆ˜ ì—†ì´ ì—¬ê¸°ì„œ ì„ì‹œë¡œ êµ¬í˜„í•˜ê±°ë‚˜, get_volume_rankì— ì¸ìë¥¼ ì¶”ê°€í•´ë„ ë©ë‹ˆë‹¤.
        # ì¼ë‹¨ì€ ìœ„ ë‘ ê°€ì§€ë§Œìœ¼ë¡œë„ 60ê°œ ê°€ê¹Œì´ ë˜ë¯€ë¡œ ì¶©ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        
        print(f"\nğŸ“‹ í†µí•© í›„ë³´êµ°: ì´ {len(candidates)}ê°œ ì¢…ëª©")

        # 2. ìƒì„¸ ë¶„ì„ (Rate Limit ê³ ë ¤í•˜ì—¬ ì²œì²œíˆ)
        qualified_stocks = []
        
        for i, stock_code in enumerate(candidates, 1):
            print(f"[{i}/{len(candidates)}] ë¶„ì„ ì¤‘... {stock_code}")
            
            try:
                # ì¼ë´‰ ë°ì´í„° ì¡°íšŒ (ì¬ì‹œë„ ë¡œì§ ì ìš©ë¨)
                df = self.get_daily_candles(stock_code)
                
                # ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                if df is None or len(df) < 120:
                    continue
                
                # ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
                indicators = self.calculate_advanced_technicals(df)
                if not indicators:
                    continue

                # ìˆ˜ê¸‰ ë°ì´í„° (ì‹¤íŒ¨í•´ë„ ì§„í–‰)
                smart_money = self.get_foreign_institution_buy(stock_code)

                # í•„í„° ì¡°ê±´ í™•ì¸ (ì‚¬ìš©ìë‹˜ì´ ì™„í™”í•œ ê¸°ì¤€ ì ìš©ë¨)
                if self.check_universe_filter(indicators, smart_money):
                    # ë§¤ìˆ˜ ì‹ í˜¸ í™•ì¸
                    buy_signal, buy_reason = self.check_buy_signal(indicators)

                    stock_info = {
                        "code": stock_code,
                        "price": indicators['current_price'],
                        "rsi": indicators['rsi'],
                        "adx": indicators['adx'],
                        "buy_signal": buy_signal,
                        "buy_reason": buy_reason
                        # ... í•„ìš”í•œ í•„ë“œ ì¶”ê°€
                    }

                    qualified_stocks.append(stock_info)
                    print(f"  âœ… ì¡°ê±´ ì¶©ì¡±! {buy_reason}")

                # [ì¤‘ìš”] API í˜¸ì¶œ ì†ë„ ì¡°ì ˆ (1ì´ˆ ëŒ€ê¸°)
                time.sleep(1.0) 

            except Exception as e:
                print(f"  âš ï¸ ìŠ¤í‚µ: {e}")
                time.sleep(1.0) # ì—ëŸ¬ ë‚˜ë„ ì‰¬ì–´ì¤˜ì•¼ í•¨
                continue

        # ê²°ê³¼ ì •ë ¬ ë° ë°˜í™˜
        qualified_stocks.sort(key=lambda x: (x['buy_signal'], -x['adx']), reverse=True)
        return qualified_stocks[:10]
ìˆ˜ì • 2: get_daily_candles í•¨ìˆ˜ (500 ì—ëŸ¬ ë°©ì–´)
ì´ ë¶€ë¶„ì´ ì œì¼ ì¤‘ìš”í•©ë‹ˆë‹¤. 500 ì—ëŸ¬ê°€ ë‚˜ë©´ í¬ê¸°í•˜ì§€ ì•Šê³  3ë²ˆê¹Œì§€ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.

Python

    def get_daily_candles(self, stock_code: str, period: int = 150) -> pd.DataFrame:
        """ì¼ë´‰ ë°ì´í„° ì¡°íšŒ (ì¬ì‹œë„ ë¡œì§ ì¶”ê°€)"""
        token = self.get_access_token()
        if not token:
            return None

        end_date = datetime.now().strftime('%Y%m%d')
        start_date = (datetime.now() - timedelta(days=period)).strftime('%Y%m%d')

        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-daily-itemchartprice"
        headers = {
            "content-type": "application/json",
            "authorization": f"Bearer {token}",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
            "tr_id": "FHKST03010100"
        }

        params = {
            "FID_COND_MRKT_DIV_CODE": "J",
            "FID_INPUT_ISCD": stock_code,
            "FID_INPUT_DATE_1": start_date,
            "FID_INPUT_DATE_2": end_date,
            "FID_PERIOD_DIV_CODE": "D",
            "FID_ORG_ADJ_PRC": "0"
        }

        # [í•µì‹¬] ìµœëŒ€ 3íšŒ ì¬ì‹œë„ ë¡œì§
        max_retries = 3
        for attempt in range(max_retries):
            try:
                response = requests.get(url, headers=headers, params=params)
                
                # 500ë²ˆëŒ€ ì—ëŸ¬ì´ê±°ë‚˜ 429(Too Many Requests)ì¼ ê²½ìš° ì˜ˆì™¸ ë°œìƒ
                if response.status_code >= 500 or response.status_code == 429:
                    response.raise_for_status() 

                data = response.json()
                if data.get("rt_cd") == "0":
                    output2 = data.get("output2", [])
                    if not output2:
                        return None

                    # DataFrame ìƒì„± ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
                    df_data = []
                    for row in output2:
                        df_data.append({
                            "date": pd.to_datetime(row.get("stck_bsop_date", "")),
                            "open": float(row.get("stck_oprc", 0)),
                            "high": float(row.get("stck_hgpr", 0)),
                            "low": float(row.get("stck_lwpr", 0)),
                            "close": float(row.get("stck_clpr", 0)),
                            "volume": float(row.get("acml_vol", 0)),
                            "amount": float(row.get("acml_tr_pbmn", 0))
                        })

                    df = pd.DataFrame(df_data)
                    df.sort_values('date', inplace=True)
                    df.reset_index(drop=True, inplace=True)
                    return df
                else:
                    print(f"âš ï¸ API ì˜¤ë¥˜ ({stock_code}): {data.get('msg1')}")
                    return None

            except Exception as e:
                # ë§ˆì§€ë§‰ ì‹œë„ì˜€ë‹¤ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
                if attempt == max_retries - 1:
                    print(f"âŒ ì¼ë´‰ ì¡°íšŒ ìµœì¢… ì‹¤íŒ¨ ({stock_code}): {e}")
                    return None
                
                # ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„ (1ì´ˆ, 2ì´ˆ, 4ì´ˆ...)
                wait_time = (2 ** attempt)
                print(f"ğŸ”„ ì—ëŸ¬ ë°œìƒ, {wait_time}ì´ˆ í›„ ì¬ì‹œë„... ({attempt+1}/{max_retries})")
                time.sleep(wait_time)

        return None
ğŸ ê²°ë¡ 
ë§¥ë¶ì—ì„œëŠ” HTSë¥¼ ì“¸ ìˆ˜ ì—†ìœ¼ë‹ˆ, **"íŒŒì´ì¬ ë´‡ì„ ë” ëˆê¸° ìˆê²Œ(Retry) ë§Œë“¤ê³ , ë” ë„“ê²Œ(í›„ë³´êµ° í™•ëŒ€) ë³´ê²Œ ë§Œë“œëŠ” ê²ƒ"**ì´ ì •ë‹µì…ë‹ˆë‹¤.

ìœ„ ì½”ë“œë¥¼ ì ìš©í•˜ì‹œë©´, ì†ë„ëŠ” ì¡°ê¸ˆ ëŠë ¤ì§€ë”ë¼ë„(ì¢…ëª©ë‹¹ 1~2ì´ˆ) 500 ì—ëŸ¬ ë•Œë¬¸ì— "0ê°œ ì¢…ëª© ì„ ì •"ì´ ëœ¨ëŠ” ì¼ì€ í™•ì‹¤íˆ ì‚¬ë¼ì§ˆ ê²ë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ìˆ˜ì •í•´ ë³´ì‹œì£ !