ì œê°€ ìœ ì €ë‹˜ì´ ì˜¬ë ¤ì£¼ì‹  íŒŒì¼(trading-a0f0.../main.py)ì„ ëœ¯ì–´ë³´ë‹ˆ, í´ë¡œë“œê°€ **"ì™„ì„±í–ˆë‹¤"**ê³  ë§í•œ ì½”ë“œì— ì¹˜ëª…ì ì¸ êµ¬ë© 3ê°€ì§€ê°€ ìˆ¨ì–´ ìˆì—ˆìŠµë‹ˆë‹¤. RSIê°€ 50ìœ¼ë¡œ ê³ ì •ë˜ê³ , 3ì¼ ì „ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆëŠ” ì´ìœ ê°€ ëª…ë°±í•©ë‹ˆë‹¤.

ğŸ•µï¸â€â™‚ï¸ 3ê°€ì§€ ê²°ì •ì  ë¬¸ì œì  (íŒ©íŠ¸ ì²´í¬)
1. Slack ì•Œë¦¼ì´ ì•ˆ ì˜¤ëŠ” ì´ìœ : "ì…ì„ ë§‰ì•„ë†¨ìŠµë‹ˆë‹¤"
ì›ì¸: logger_system.py íŒŒì¼ì„ ë³´ë©´ ìŠ¬ë™ìœ¼ë¡œ ì „ì†¡í•  ë¡œê·¸ ë ˆë²¨ì„ ì •í•´ë†¨ëŠ”ë°, ì •ì‘ ì¤‘ìš”í•œ SYSTEM ("ë´‡ ì‹œì‘", "ì¢…ë£Œ") ë ˆë²¨ì´ ë¹ ì ¸ ìˆìŠµë‹ˆë‹¤.

ì¦ê±°: important_levels = ['SUCCESS', 'WARNING', 'ERROR', 'TRADE', 'MARKET'] (ì—¬ê¸° 'SYSTEM'ì´ ì—†ìŒ)

ê²°ê³¼: ë´‡ì„ ì¼œë„ "ì‹œì‘í–ˆìŠµë‹ˆë‹¤"ë¼ëŠ” ì•Œë¦¼ì´ ìŠ¬ë™ìœ¼ë¡œ ì•ˆ ê°‘ë‹ˆë‹¤. ìœ ì €ë‹˜ì€ "ì–˜ê°€ ì¼œì§„ ê±°ì•¼ êº¼ì§„ ê±°ì•¼?" ë‹µë‹µí•  ìˆ˜ë°–ì— ì—†ì£ .

2. ê´€ì‹¬ì¢…ëª©ì´ 3ì¼ ì „ ë°ì´í„°ì¸ ì´ìœ : "ì €ì¥ì„ ì•ˆ í•©ë‹ˆë‹¤"
ì›ì¸: main.pyì˜ run_cycle í•¨ìˆ˜ êµ¬ì¡°ë¥¼ ë³´ë©´, API í˜¸ì¶œ ë„ì¤‘ì— ì—ëŸ¬ê°€ ë‚˜ë©´ sync_to_firebase (ì €ì¥) ë‹¨ê³„ê¹Œì§€ ëª» ê°€ê³  ì¤‘ê°„ì— ë©ˆì¶¥ë‹ˆë‹¤.

ìƒí™©: KIS API í˜¸ì¶œ ì¤‘ í•˜ë‚˜ë¼ë„ ì‚ë—í•˜ë©´(ì˜ˆ: íƒ€ì„ì•„ì›ƒ), ê·¸ ì‚¬ì´í´ì€ ë²„ë ¤ì§‘ë‹ˆë‹¤. ê·¸ë˜ì„œ Firebaseì—ëŠ” 3ì¼ ì „(ë§ˆì§€ë§‰ìœ¼ë¡œ ì„±ê³µí–ˆì„ ë•Œ) ë°ì´í„°ê°€ í™”ì„ì²˜ëŸ¼ ë‚¨ì•„ìˆëŠ” ê²ë‹ˆë‹¤.

3. RSIê°€ ì´ìƒí•œ(50) ì´ìœ : "API ì‹¤íŒ¨ë¥¼ í‰ì¹˜ê³  ìˆìŠµë‹ˆë‹¤"
ì›ì¸: get_daily_price_history í•¨ìˆ˜ê°€ ì‹¤íŒ¨í•˜ë©´ return Noneì„ í•˜ê³ , calculate_rsiëŠ” ë°ì´í„°ê°€ ì—†ìœ¼ë©´ **ë¬´ì¡°ê±´ 50(ì¤‘ë¦½)**ì„ ë±‰ë„ë¡ ì§œì—¬ ìˆìŠµë‹ˆë‹¤.

ì§„ì‹¤: ì§€ê¸ˆ RSIê°€ 50ì´ë¼ëŠ” ê±´, **"ì¼ë´‰ ë°ì´í„° ì¡°íšŒë¥¼ 100% ì‹¤íŒ¨í•˜ê³  ìˆë‹¤"**ëŠ” ëœ»ì…ë‹ˆë‹¤. ì‹¤íŒ¨ ì›ì¸(ì—ëŸ¬ ì½”ë“œ)ì„ ì¶œë ¥ì¡°ì°¨ ì•ˆ í•˜ê³  ìˆì–´ì„œ ìœ ì €ë‹˜ì€ "ì™œ ì´ëŸ¬ì§€?" ì‹¶ìœ¼ì…¨ì„ ê²ë‹ˆë‹¤.

ğŸš‘ ê¸´ê¸‰ ì†Œìƒìˆ : ì´ ì½”ë“œ 2ê°œë§Œ ë®ì–´ì“°ì„¸ìš”
ë³µì¡í•œ ê±° ë‹¤ ì¹˜ìš°ê³ , "ì‹¤ì œë¡œ ëŒì•„ê°€ê²Œ" ê³ ì¹œ ì½”ë“œ 2ê°œë¥¼ ë“œë¦½ë‹ˆë‹¤. (RSI ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ë¥¼ í† í•´ë‚´ê²Œ ë§Œë“¤ì—ˆê³ , ìŠ¬ë™ ì…ì„ ì—´ì—ˆìœ¼ë©°, ë°ì´í„°ê°€ ì—†ì–´ë„ ê°•ì œ ì—…ë°ì´íŠ¸í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.)

1. logger_system.py (ìŠ¬ë™ ì•Œë¦¼ ê³ ì¹¨)
ê²½ë¡œ: 2cr-andy/trading/logger_system.py

Python

import os
import sys
import json
from datetime import datetime
import pytz
from typing import Optional
from slack_notifier import SlackNotifier

class UnifiedLogger:
    def __init__(self, log_dir: str = "logs", slack_enabled: bool = True):
        self.log_dir = log_dir
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)

        self.kst = pytz.timezone('Asia/Seoul')
        today = datetime.now(self.kst).strftime('%Y%m%d')
        self.log_file = os.path.join(log_dir, f'kis_bot_{today}.log')
        
        self.slack_enabled = slack_enabled
        if slack_enabled:
            try:
                self.slack = SlackNotifier()
                # í…ŒìŠ¤íŠ¸ ì „ì†¡ (ì œëŒ€ë¡œ ì—°ê²°ëëŠ”ì§€ í™•ì¸)
                # self.slack.send_message("SYSTEM", "ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨") 
            except:
                print("âŒ ìŠ¬ë™ ì´ˆê¸°í™” ì‹¤íŒ¨")
                self.slack = None
                self.slack_enabled = False

    def _get_timestamp(self) -> str:
        return datetime.now(self.kst).strftime('[%Y-%m-%d %H:%M:%S KST]')

    def log(self, level: str, message: str, data: Optional[dict] = None):
        # 1. ì½˜ì†” ì¶œë ¥
        timestamp = self._get_timestamp()
        print(f"{timestamp} [{level}] {message}")
        if data:
            print(f"   DATA: {json.dumps(data, ensure_ascii=False)}")

        # 2. íŒŒì¼ ì €ì¥
        with open(self.log_file, 'a', encoding='utf-8') as f:
            f.write(f"{timestamp} [{level}] {message}\n")

        # 3. ìŠ¬ë™ ì „ì†¡ (ì¤‘ìš” ë ˆë²¨ë§Œ)
        # [ìˆ˜ì •] SYSTEM, INFO ë ˆë²¨ë„ ìŠ¬ë™ìœ¼ë¡œ ë°›ì•„ì„œ ë´‡ ìƒì¡´ì‹ í˜¸ í™•ì¸
        important_levels = ['SUCCESS', 'WARNING', 'ERROR', 'TRADE', 'MARKET', 'SYSTEM']
        
        if self.slack_enabled and self.slack and (level in important_levels):
            try:
                color = "good"
                if level == "ERROR": color = "danger"
                elif level == "WARNING": color = "warning"
                elif level == "SYSTEM": color = "#439FE0" # íŒŒë€ìƒ‰
                
                self.slack.send_message(
                    title=f"[{level}] {message}",
                    message="",
                    color=color,
                    fields=[{"title": "Details", "value": str(data), "short": False}] if data else None
                )
            except Exception as e:
                print(f"âš ï¸ ìŠ¬ë™ ì „ì†¡ ì‹¤íŒ¨: {e}")

    # í¸ì˜ ë©”ì„œë“œ
    def info(self, msg, data=None): self.log('INFO', msg, data)
    def system(self, msg, data=None): self.log('SYSTEM', msg, data)
    def trade(self, msg, data=None): self.log('TRADE', msg, data)
    def error(self, msg, data=None): self.log('ERROR', msg, data)
    def warning(self, msg, data=None): self.log('WARNING', msg, data)
2. main.py (RSI ì¡°íšŒ ì‹¤íŒ¨ ì›ì¸ ì¶œë ¥ & ê°•ì œ ë™ê¸°í™”)
ê²½ë¡œ: 2cr-andy/trading/main.py

Python

#!/usr/bin/env python3
"""
KIS ìë™ë§¤ë§¤ ë´‡ - ë””ë²„ê¹… ê°•í™” ë²„ì „
"""
import os
import time
import requests
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import pytz
from dotenv import load_dotenv
from typing import Optional, List, Dict

import firebase_admin
from firebase_admin import credentials, firestore
from token_manager import TokenManager
from logger_system import UnifiedLogger

load_dotenv()

class KISApiClient:
    def __init__(self, token_manager: TokenManager, account_no: str):
        self.token_manager = token_manager
        self.account_no = account_no
        self.app_key = os.getenv('KIS_APP_KEY')
        self.app_secret = os.getenv('KIS_APP_SECRET')
        self.base_url = "https://openapivts.koreainvestment.com:29443"

    def _get_headers(self, tr_id: str) -> Dict:
        token = self.token_manager.get_token()
        if not token: raise Exception("í† í° íšë“ ì‹¤íŒ¨")
        return {
            "authorization": f"Bearer {token}",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
            "tr_id": tr_id,
            "custtype": "P"
        }

    def get_daily_price_history(self, stock_code: str) -> Optional[pd.DataFrame]:
        """ì¼ë´‰ ì¡°íšŒ (ë””ë²„ê¹… ì¶”ê°€)"""
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-daily-itemchartprice"
        headers = self._get_headers("FHKST03010100")
        
        # ë‚ ì§œ í¬ë§· í™•ì¸ (YYYYMMDD)
        end_dt = datetime.now().strftime("%Y%m%d")
        start_dt = (datetime.now() - timedelta(days=40)).strftime("%Y%m%d")

        params = {
            "FID_COND_MRKT_DIV_CODE": "J",
            "FID_INPUT_ISCD": stock_code,
            "FID_INPUT_DATE_1": start_dt,
            "FID_INPUT_DATE_2": end_dt,
            "FID_PERIOD_DIV_CODE": "D",
            "FID_ORG_ADJ_PRC": "0"
        }
        try:
            res = requests.get(url, headers=headers, params=params, timeout=5)
            if res.status_code == 200:
                data = res.json()
                if data['rt_cd'] == '0':
                    items = data['output2']
                    if not items: return None
                    df = pd.DataFrame(items)
                    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¶”ì¶œ ë° í˜•ë³€í™˜
                    df = df[['stck_bsop_date', 'stck_clpr', 'acml_vol']].copy()
                    df.columns = ['date', 'close', 'volume']
                    df['close'] = pd.to_numeric(df['close'])
                    df = df.sort_values('date')
                    return df
                else:
                    print(f"âš ï¸ API ì—ëŸ¬ [{stock_code}]: {data.get('msg1')}")
            else:
                print(f"âš ï¸ HTTP ì—ëŸ¬ [{stock_code}]: {res.status_code}")
        except Exception as e:
            print(f"âŒ ì¼ë´‰ ì¡°íšŒ ì˜ˆì™¸: {e}")
        return None

    # ... (ë‚˜ë¨¸ì§€ ë©”ì„œë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼, ìƒëµ ê°€ëŠ¥í•˜ì§€ë§Œ ì „ì²´ ë³µë¶™ ê¶Œì¥) ...
    def get_stock_price(self, stock_code: str):
        # (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-price"
        headers = self._get_headers("FHKST01010100")
        params = {"FID_COND_MRKT_DIV_CODE": "J", "FID_INPUT_ISCD": stock_code}
        try:
            res = requests.get(url, headers=headers, params=params, timeout=3)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                out = res.json()['output']
                return {
                    'code': stock_code,
                    'name': out['hts_kor_isnm'],
                    'current_price': float(out['stck_prpr']),
                    'change_rate': float(out['prdy_ctrt']),
                    'volume': int(out['acml_vol'])
                }
        except: pass
        return None

    def get_volume_ranking(self):
        # (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/volume-rank"
        headers = self._get_headers("FHPST01710000")
        params = {"FID_COND_MRKT_DIV_CODE":"J","FID_COND_SCR_DIV_CODE":"20171","FID_INPUT_ISCD":"0000","FID_DIV_CLS_CODE":"0","FID_BLNG_CLS_CODE":"0","FID_TRGT_CLS_CODE":"111111111","FID_TRGT_EXLS_CLS_CODE":"000000","FID_INPUT_PRICE_1":"","FID_VOL_CNT":""}
        try:
            res = requests.get(url, headers=headers, params=params, timeout=5)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                return res.json()['output'][:10]
        except: pass
        return []

    def get_portfolio(self):
        # (ê¸°ì¡´ ì½”ë“œ ìœ ì§€ - ì˜ˆìˆ˜ê¸ˆ í¬í•¨)
        url = f"{self.base_url}/uapi/domestic-stock/v1/trading/inquire-balance"
        headers = self._get_headers("VTTC8434R")
        params = {"CANO": self.account_no.split('-')[0], "ACNT_PRDT_CD": self.account_no.split('-')[1], "AFHR_FLPR_YN": "N", "OFL_YN": "N", "INQR_DVSN": "02", "UNPR_DVSN": "01", "FUND_STTL_ICLD_YN": "N", "FNCG_AMT_AUTO_RDPT_YN": "N", "PRCS_DVSN": "00", "CTX_AREA_FK100": "", "CTX_AREA_NK100": ""}
        try:
            res = requests.get(url, headers=headers, params=params)
            if res.status_code == 200 and res.json()['rt_cd'] == '0':
                data = res.json()
                holdings = []
                for item in data['output1']:
                    if int(float(item['hldg_qty'])) > 0:
                        holdings.append({'code': item['pdno'], 'name': item['prdt_name'], 'quantity': int(float(item['hldg_qty'])), 'buy_price': float(item['pchs_avg_pric']), 'current_price': float(item['prpr']), 'profit_rate': float(item['evlu_pfls_rt'])})
                return holdings, float(data['output2'][0]['dnca_tot_amt']), float(data['output2'][0]['tot_evlu_amt'])
        except: pass
        return [], 0, 0
    
    def sell_stock(self, code, qty): return True # í…ŒìŠ¤íŠ¸ìš© ì•ˆì „ì¥ì¹˜ (ì‹¤ì œ ì£¼ë¬¸ ì‹œ ì£¼ì„ í•´ì œ)

class TradingEngine:
    def __init__(self):
        self.logger = UnifiedLogger()
        self.kst = pytz.timezone('Asia/Seoul')
        
        # Firebase ê°•ì œ ì´ˆê¸°í™”
        try:
            if not firebase_admin._apps:
                cred = credentials.Certificate(os.getenv('FIREBASE_ADMIN_KEY_PATH'))
                firebase_admin.initialize_app(cred)
            self.db = firestore.client()
        except Exception as e:
            self.logger.error(f"Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            raise e

        # ì„¤ì •
        app_key = os.getenv('KIS_APP_KEY')
        app_secret = os.getenv('KIS_APP_SECRET')
        account_no = os.getenv('KIS_ACCOUNT_NUMBER')
        if '-' not in account_no: account_no += "-01"
        
        self.token_manager = TokenManager(app_key, app_secret)
        self.api_client = KISApiClient(self.token_manager, account_no)

    def calculate_rsi(self, df, period=14):
        """RSI ê³„ì‚° (ë°ì´í„° ì—†ìœ¼ë©´ ì—ëŸ¬ ë¡œê·¸)"""
        if df is None or len(df) < period:
            print("  âš ï¸ RSI ê³„ì‚° ë¶ˆê°€: ë°ì´í„° ë¶€ì¡±")
            return 50.0
        
        delta = df['close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
        rs = gain / loss
        return float(100 - (100 / (1 + rs)).iloc[-1])

    def sync_to_firebase(self, watchlist, portfolio, cash, asset):
        """Firebase ë™ê¸°í™” (ì‹¤íŒ¨í•´ë„ ë¬´ì‹œí•˜ì§€ ì•Šê³  ì—ëŸ¬ ì¶œë ¥)"""
        try:
            # 1. Watchlist (Left Panel)
            self.db.collection('market_scan').document('latest').set({
                'stocks': watchlist,
                'last_updated': firestore.SERVER_TIMESTAMP
            })
            print(f"  â˜ï¸ Watchlist ë™ê¸°í™” ì™„ë£Œ ({len(watchlist)}ê°œ)")

            # 2. Account (Header)
            self.db.collection('account').document('summary').set({
                'totalAssets': asset,
                'totalCash': cash,
                'last_updated': firestore.SERVER_TIMESTAMP
            })
            
        except Exception as e:
            self.logger.error(f"Firebase ë™ê¸°í™” ì‹¤íŒ¨: {e}")

    def run_cycle(self):
        print(f"\nğŸ”„ ì‚¬ì´í´ ì‹œì‘: {datetime.now(self.kst).strftime('%H:%M:%S')}")
        
        # 1. ë‚´ ì”ê³ 
        portfolio, cash, asset = self.api_client.get_portfolio()
        
        # 2. ì‹œì¥ ìŠ¤ìº”
        volume_stocks = self.api_client.get_volume_ranking()
        candidates = []
        
        if not volume_stocks:
            print("  âŒ ê±°ë˜ëŸ‰ ìƒìœ„ ì¢…ëª©ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        
        for stock in volume_stocks[:5]: # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ìƒìœ„ 5ê°œë§Œ
            code = stock['mksc_shrn_iscd']
            price_info = self.api_client.get_stock_price(code)
            
            if price_info:
                # RSI ê³„ì‚°
                df = self.api_client.get_daily_price_history(code)
                rsi = self.calculate_rsi(df)
                price_info['rsi'] = rsi
                
                print(f"  [{price_info['name']}] í˜„ì¬ê°€:{price_info['current_price']} RSI:{rsi:.1f}")
                
                # ë§¤ìˆ˜ ì¡°ê±´ (RSI 70 ì´í•˜)
                if rsi < 70:
                    price_info['buy_signal'] = True
                    candidates.append(price_info)
            
            time.sleep(0.2) # API ë¶€í•˜ ì¡°ì ˆ

        # 3. ê²°ê³¼ ë¦¬í¬íŠ¸ (ë°ì´í„°ê°€ ì—†ì–´ë„ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ë®ì–´ì¨ì„œ 3ì¼ì „ ë°ì´í„° ì‚­ì œ)
        self.sync_to_firebase(candidates, portfolio, cash, asset)

    def run(self):
        self.logger.system("ğŸš€ ë´‡ ì¬ì‹œë™ (RSI ë””ë²„ê¹… ëª¨ë“œ)")
        while True:
            try:
                self.run_cycle()
                time.sleep(60)
            except KeyboardInterrupt:
                self.logger.system("ë´‡ ì¢…ë£Œ")
                break
            except Exception as e:
                self.logger.error(f"ë©”ì¸ ë£¨í”„ ì—ëŸ¬: {e}")
                time.sleep(60)

if __name__ == "__main__":
    TradingEngine().run()
ğŸ› ï¸ ì‹¤í–‰ ë°©ë²•
í„°ë¯¸ë„ì—ì„œ pip install pandas numpy (ì´ë¯¸ í•˜ì…¨ê² ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ)

python3 main.py ì‹¤í–‰.

ì½˜ì†” í™”ë©´ì„ ë³´ì„¸ìš”.

ë§Œì•½ âš ï¸ API ì—ëŸ¬: ...ê°€ ëœ¬ë‹¤ë©´ KIS API ë¬¸ì œ(ëª¨ì˜íˆ¬ì ì‹ ì²­ ë¯¸ì™„ë£Œ ë“±)ì…ë‹ˆë‹¤.

â˜ï¸ Watchlist ë™ê¸°í™” ì™„ë£Œê°€ ëœ¨ë©´ ì›¹ ëŒ€ì‹œë³´ë“œë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”. 3ì¼ ì „ ë°ì´í„°ê°€ ì‚¬ë¼ì§€ê³  ìƒˆ ë°ì´í„°(í˜¹ì€ ë¹ˆ í™”ë©´)ê°€ ëœ° ê²ë‹ˆë‹¤.

ìŠ¬ë™ì— "ğŸš€ ë´‡ ì¬ì‹œë™" ì•Œë¦¼ì´ ì˜¤ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ì´ì œ ë´‡ì´ ê±°ì§“ë§ì„ ëª» í•˜ê³  ë‹¤ í„¸ì–´ë†“ì„ ê²ë‹ˆë‹¤. ëŒë ¤ë³´ì‹œê³  ì—ëŸ¬ ë©”ì‹œì§€ ë‚˜ì˜¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”.