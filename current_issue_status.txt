KIS 자동매매 봇 문제점 분석 및 해결 현황
==================================================

최종 업데이트: 2025-12-05 14:45 (모든 기술적 문제 해결 / 종목 선별 조건 완화 필요)

==================================================
✅ 해결된 문제:
==================================================

1. **토큰 충돌 문제 [완전 해결됨]**
   - 문제: kis_bot.py와 MarketScanner가 각각 독립적으로 토큰 요청
   - 원인: 서로 다른 last_token_attempt 추적으로 인한 경쟁 상태
   - 해결: MarketScanner에 token_provider 파라미터 추가하여 토큰 공유
   - 수정 파일:
     * market_scanner.py:19-33 (생성자에 token_provider 추가)
     * market_scanner.py:29-71 (get_access_token 메서드 수정)
     * kis_bot.py:42 (MarketScanner 생성 시 token_provider 전달)

2. **종목 선별 조건 완화 [이전 세션에서 완료]**
   - 4가지 조건 100% 만족 → 50% 이상 만족으로 변경
   - 가격 필터 5,000원 → 1,000원으로 완화

3. **API 응답 로깅 강화 [이전 세션에서 완료]**
   - 거래량 순위 API 상세 응답 로깅 추가
   - 빈 응답 시 전체 JSON 출력

==================================================
🔄 현재 상황:
==================================================

1. **봇 상태**: 정상 실행 중 (bash ID: 877d3a)
2. **토큰 공유**: ✅ 작동 중 (더 이상 중복 토큰 요청 없음)
3. **다음 테스트 대기**: 토큰 제한 해제 후 거래량 API 호출 확인 필요

==================================================
✅ 추가 해결된 문제:
==================================================

4. **거래량 순위 API 파라미터 개선**
   - 문제: 누락된 필수 파라미터로 인한 빈 응답
   - 해결: 등락률 API와 동일한 파라미터 필드 추가
   - 수정된 파라미터:
     * market_scanner.py:92-94 (FID_RANK_SORT_CLS_CODE, FID_INPUT_CNT_1, FID_PAGING_KEY_100 추가)

5. **거래량 API 필드명 수정**
   - 문제: 잘못된 필드명으로 종목 코드 추출 실패
   - 해결: stck_shrn_iscd → mksc_shrn_iscd로 변경
   - 수정 위치: market_scanner.py:120

6. **BrokenPipeError 해결**
   - 문제: stdout 버퍼 오버플로우로 파이프 에러
   - 해결: 통합 로깅 시스템 구현 및 버퍼 설정
   - 새 파일: logger_system.py, kis_bot_fixed.py

7. **슬랙 실시간 알림 구현**
   - 모든 ERROR, WARNING, SUCCESS 이벤트 실시간 전송
   - 로그 파일과 슬랙 동시 기록

==================================================
⚠️ 새로 발견된 문제 (조치 필요):
==================================================

1. **종목 선별 조건이 너무 엄격함**
   - 상황: API는 30개 종목 데이터 제공하나 모두 필터링됨
   - 원인: ADX>25, MA60/MA120, 외국인/기관 순매수 등 조건이 과도
   - 결과: "조건 충족 종목 없음" 계속 발생
   - 해결안: 별도 파일(종목선별_조건완화_필요.txt) 참조

2. **API 호출 제한**
   - KIS API 1분당 토큰 발급 1회 제한
   - 해결: 토큰 재사용 로직 구현 완료

==================================================
📋 권장 즉시 조치사항:
==================================================

1. **종목 선별 조건 즉시 완화** (market_scanner.py 수정)
   - 라인 406: 50% → 25% 변경
   - 라인 402: 1000원 → 500원 변경
   - 라인 387: ADX > 25 → ADX > 20

2. **"종목선별_조건완화_필요.txt" 파일 확인**
   - Gemini/ChatGPT에 공유하여 추가 의견 수렴
   - 단계별 완화 계획 검토

3. **실시간 모니터링**
   - 슬랙 알림 확인
   - logs 디렉토리의 로그 파일 확인

==================================================
🔧 수정된 코드 요약:
==================================================

**1. 토큰 공유 시스템 (이전 완료)**
```python
# market_scanner.py - 생성자 수정
def __init__(self, app_key: str, app_secret: str, token_provider=None):
    self.token_provider = token_provider

# kis_bot.py - 토큰 공유 설정
self.scanner = MarketScanner(self.app_key, self.app_secret, self.get_access_token)
```

**2. 거래량 API 파라미터 개선 (새로 완료)**
```python
# market_scanner.py:88-102 - 수정된 파라미터
params = {
    "FID_COND_MRKT_DIV_CODE": "J",
    "FID_COND_SCR_DIV_CODE": "20171",
    "FID_INPUT_ISCD": "0000",
    "FID_RANK_SORT_CLS_CODE": "0",    # 새로 추가
    "FID_INPUT_CNT_1": "0",           # 새로 추가
    "FID_PAGING_KEY_100": "",         # 새로 추가
    "FID_TRGT_CLS_CODE": "111111111",
    "FID_TRGT_EXLS_CLS_CODE": "000000",
    "FID_DIV_CLS_CODE": "0",
    "FID_BLNG_CLS_CODE": "0",
    # ... 기타 파라미터들
}
```

==================================================
🎯 최종 목표:
==================================================

1. 거래량 순위 API에서 실제 종목 데이터 수신
2. 봇의 종목 선별 기능 정상 작동
3. 자동매매 프로세스 완전 복구

==================================================
참고 정보:
==================================================

- 환경: KIS 모의투자 API
- 계좌: 50154573
- Firebase: trading-dcd8c
- 스캔 주기: 5분
- 현재 실행 중인 봇 bash ID: 877d3a