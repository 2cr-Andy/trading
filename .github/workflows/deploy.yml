name: ğŸš€ Deploy KIS Bot to GCP

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}

    - name: ğŸ“ Create .env file
      run: |
        cat > .env << 'EOF'
        # KIS API ì„¤ì • (ëª¨ì˜íˆ¬ì)
        KIS_APP_KEY=${{ secrets.KIS_APP_KEY }}
        KIS_APP_SECRET=${{ secrets.KIS_APP_SECRET }}
        KIS_ACCOUNT_NUMBER=${{ secrets.KIS_ACCOUNT_NUMBER }}
        KIS_ENVIRONMENT=VIRTUAL

        # ì‹¤ì „íˆ¬ì (ì£¼ì„ ì²˜ë¦¬)
        # KIS_APP_KEY_REAL=${{ secrets.KIS_APP_KEY_REAL }}
        # KIS_APP_SECRET_REAL=${{ secrets.KIS_APP_SECRET_REAL }}
        # KIS_ACCOUNT_NUMBER_REAL=${{ secrets.KIS_ACCOUNT_NUMBER_REAL }}

        # Firebase
        FIREBASE_PROJECT_NAME=trading
        FIREBASE_ADMIN_KEY_PATH=/home/${{ secrets.GCP_VM_USER }}/trading/firebase-admin-key.json

        # Slack ì„¤ì • (Bot Tokenë§Œ ì‚¬ìš©)
        SLACK_CHANNEL=#kis-bot
        SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
        EOF

    - name: ğŸ“¦ Deploy to GCP VM
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} << 'ENDSSH'

        # ê¸°ì¡´ ë´‡ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
        echo "ğŸ›‘ ê¸°ì¡´ ë´‡ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
        pkill -f "kis_bot.py" || true
        sleep 2

        # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
        cd ~/trading

        # ìµœì‹  ì½”ë“œ pull
        echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
        git fetch origin
        git reset --hard origin/main

        # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
        echo "ğŸ“¦ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì¤‘..."
        source venv/bin/activate
        pip install -r requirements.txt --quiet

        echo "âœ… ë°°í¬ ì™„ë£Œ!"
        ENDSSH

    - name: ğŸ“ Upload .env file
      run: |
        scp -o StrictHostKeyChecking=no .env ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }}:~/trading/.env

    - name: ğŸš€ Restart KIS Bot
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} << 'ENDSSH'
        cd ~/trading
        source venv/bin/activate

        # ë°±ê·¸ë¼ìš´ë“œë¡œ ë´‡ ì‹œì‘
        echo "ğŸš€ KIS ë´‡ ì‹œì‘ ì¤‘..."
        nohup python3 kis_bot.py > bot.log 2>&1 &

        # ì‹œì‘ í™•ì¸
        sleep 3
        if pgrep -f "kis_bot.py" > /dev/null; then
          echo "âœ… KIS ë´‡ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“Š í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
          pgrep -f "kis_bot.py" | head -1 | xargs ps -p
        else
          echo "âŒ ë´‡ ì‹œì‘ ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸:"
          tail -10 bot.log
          exit 1
        fi
        ENDSSH

    - name: ğŸ“± Slack Notification - Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"ğŸ‰ *KIS Bot ë°°í¬ ì„±ê³µ!*\nâœ… `${{ github.sha }}` ì»¤ë°‹ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸš€ ë´‡ì´ GCP VMì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."}' \
        https://hooks.slack.com/services/T0123456789/B0123456789/XXXXXXXXXXXXXXXXXXXXXXXXX

    - name: ğŸ”„ Rollback on failure
      if: failure()
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} << 'ENDSSH'
        echo "ğŸ”„ ë¡¤ë°± ì‹œë„ ì¤‘..."
        cd ~/trading

        # ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±
        git log --oneline -5

        # ë´‡ ì¬ì‹œì‘ ì‹œë„
        source venv/bin/activate
        pkill -f "kis_bot.py" || true
        sleep 2
        nohup python3 kis_bot.py > bot.log 2>&1 &
        ENDSSH

    - name: ğŸ“± Slack Notification - Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"âŒ *KIS Bot ë°°í¬ ì‹¤íŒ¨!*\nğŸš¨ `${{ github.sha }}` ì»¤ë°‹ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nğŸ” GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."}' \
        https://hooks.slack.com/services/T0123456789/B0123456789/XXXXXXXXXXXXXXXXXXXXXXXXX